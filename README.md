## Simulatore Stocastico PV

Monte Carlo toolkit for residential photovoltaic + battery systems. The project now bundles:

- **Reusable simulation engine**: stochastic solar model, battery degradation bank, inverter dispatch, price evolution, and economic KPIs (NPV/IRR).
- **PV electrical modeling**: single-diode parameter estimator (`PVModelSingleDiode`) for future integration with detailed panel databases.
- **Application layer**: orchestrator shared by CLI, API, and optimization routines with persistence and reporting helpers.
- **Delivery surfaces**: Python package, CLI entry point, FastAPI backend (with autogenerated docs), and a lightweight frontend (Docker/Vite) to experiment with scenarios.
- **Database support**: SQLite by default, PostgreSQL via `POSTGRES_DSN`, with persistence of hardware, scenarios, optimizations, and runs.
- **Automated tests**: pytest suite covering API, configuration, persistence, simulation models, and reporting.

---

## Repository layout

| Path | Description |
|------|-------------|
| `sim_stochastic_pv/simulation/` | Core physical/economic models (solar, prices, battery, inverter, Monte Carlo). |
| `sim_stochastic_pv/application.py` | High-level orchestrator shared across CLI/API. |
| `sim_stochastic_pv/cli.py` | CLI entry point (`python -m sim_stochastic_pv.cli ...`). |
| `sim_stochastic_pv/api/` | FastAPI router, schemas, and app wiring. |
| `sim_stochastic_pv/persistence.py` | DB CRUD helpers for components, scenarios, optimizations, and results. |
| `frontend/` | Optional Vite/TypeScript UI (served via Docker container). |
| `Dockerfile.backend`, `frontend/Dockerfile` | Production images for backend and frontend. |
| `docker-compose.yml` | Compose stack exposing backend on `:8000` and frontend on `:4173`. |
| `tests/` | Pytest suite (fast, purely in-memory). |

---

## Requirements

- Python 3.11+ (dev environment tested on 3.13)
- pip + virtualenv
- SQLite (bundled) or PostgreSQL (optional)
- Docker (optional, for containerized stack)

`requirements.txt` lists runtime deps (FastAPI, NumPy, Pandas, Matplotlib, SciPy, SQLAlchemy, etc.). Install dev-only tools (pytest, mypy, ruff…) as needed.

---

## Local setup (Python)

```bash
git clone <repo>
cd sim_stochastic_pv
python -m venv venv
source venv/bin/activate        # .\venv\Scripts\activate on Windows
pip install -r requirements.txt
```

Create an optional `.env` to override defaults:

```bash
POSTGRES_DSN=postgresql+psycopg://user:pass@host:5432/database   # enables Postgres
SIM_PV_DB_PATH=/absolute/path/to/sim_pv.db                      # custom SQLite path
```

Without `POSTGRES_DSN` the app will materialize `sim_pv.db` in the repo root.

If Matplotlib/font cache warnings appear (common on read-only environments), export:

```bash
export MPLCONFIGDIR=$(pwd)/.cache/matplotlib
export XDG_CACHE_HOME=$(pwd)/.cache
```

---

## Containerized setup

To spin up the full stack (backend API + frontend GUI) without touching your Python env:

```bash
docker compose up --build
```

- Backend (FastAPI) available at `http://localhost:8000`
- Swagger UI at `http://localhost:8000/docs`, ReDoc at `/redoc`
- Frontend served from `http://localhost:4173` (talks to backend container)

Volumes mount the local database and source tree for live reload during development (`./sim_pv.db`, `./sim_stochastic_pv`, `./api_main.py`).

To run backend only:

```bash
docker compose up --build backend
```

---

## Usage modes

### Python library

```python
from sim_stochastic_pv.application import SimulationApplication
from sim_stochastic_pv.result_builder import ResultBuilder
from sim_stochastic_pv.persistence import PersistenceService

persistence = PersistenceService()
builder = ResultBuilder()
app = SimulationApplication(save_outputs=False, persistence=persistence, result_builder=builder)
summary = app.run_analysis(n_mc=100)
```

Simulation models (solar, prices, PV diode model, battery bank, etc.) are available directly from `sim_stochastic_pv.simulation`.

### CLI

Core commands continue to run on-the-fly simulations:

```bash
python -m sim_stochastic_pv.cli analyze --n-mc 200
python -m sim_stochastic_pv.cli analyze --scenario-file examples/custom_scenario.json
python -m sim_stochastic_pv.cli optimize --n-mc 50
python -m sim_stochastic_pv.cli analyze --no-save   # skip saving CSV/plots
```

- `analyze`: single-scenario Monte Carlo (defaults defined in `scenario_setup.py`).
- `optimize`: multi-scenario campaign with PV/battery/inverter sweeps.
- Outputs: DB entries + optional CSV/plots under `results/<timestamp>_<scenario>/`.

The CLI now mirrors the API workflow, letting you manage the catalog and run database-backed scenarios/campaigns without touching HTTP:

```bash
# Hardware catalog
python -m sim_stochastic_pv.cli hardware upsert-inverter --name Primo5 --p-ac-max-kw 5 --price-eur 1500
python -m sim_stochastic_pv.cli hardware upsert-panel --name Longi540 --power-w 540 --price-eur 200
python -m sim_stochastic_pv.cli hardware list --type inverter

# Saved scenarios
python -m sim_stochastic_pv.cli scenario save --name base_case --file examples/home_away_default.json
python -m sim_stochastic_pv.cli scenario list
python -m sim_stochastic_pv.cli scenario run --name base_case --seed 42 --n-mc 200

# Saved campaigns (optimization space)
python -m sim_stochastic_pv.cli campaign save --name premium_sweep --file examples/campaign_template.json
python -m sim_stochastic_pv.cli campaign run --name premium_sweep --seed 321 --n-mc 50
```

- Scenario/campaign JSON format is identical to the API payloads (`config_type`, `data` with hardware IDs, load profiles, solar, energy, price, economic, optimization, etc.).
- When running saved configurations, the CLI hydrates hardware/profile IDs from the DB (always uses the latest specs).
- Use `--file` on the `run` subcommands to execute ad-hoc JSON without saving it first.
- `--no-save` is available on `scenario run`/`campaign run` to skip CSV/plot exports even if the `ResultBuilder` is installed.

### FastAPI backend

Start locally:

```bash
source venv/bin/activate
uvicorn api_main:app --reload
```

Key endpoints (all prefixed by `/api`):

| Method | Path | Description |
|--------|------|-------------|
| `POST` | `/api/analysis` | Execute a single scenario run, return summary metrics. |
| `POST` | `/api/optimization` | Kick off an optimization batch and return best options. |
| `GET`  | `/api/runs` | List persisted runs with metadata. |

Docs + interactive “Try it out” page: `http://localhost:8000/docs`.

### Frontend

Used mainly for demos. Either rely on `docker compose up frontend` or run it manually:

```bash
cd frontend
npm install
npm run dev      # connects to backend on http://localhost:8000
```

Consult `frontend/README.md` (if present) for customizations.

---

## Configuration highlights

- `.env` handled by `sim_stochastic_pv.config`: `POSTGRES_DSN` and `SIM_PV_DB_PATH` control SQLAlchemy DSN.
- Persistence service writes to the configured DB and is shared by CLI/API.
- Report builder writes CSV/plots under `results/`.
- Randomness controlled via `numpy.random.Generator`; seeds can be set via CLI/API payloads.

---

## Testing

```bash
source venv/bin/activate
pytest
```

The suite (15 tests) covers API contract, configuration defaults, persistence layer, simulation models (battery, solar, Monte Carlo), and result builder. Tests rely on SQLite in-memory DBs and temporary folders, so they never mutate `sim_pv.db` or `results/`.

For new tests:

- Add fixtures to `tests/conftest.py`.
- Document behavior with docstrings/comments when non-trivial.
- Keep Monte Carlo randomness deterministic by seeding RNGs.

---

## Troubleshooting

- **Swagger UI not reachable**: ensure backend container/uvicorn is running (`docker compose ps`, `uvicorn api_main:app --reload`).
- **ImportError for SciPy constants**: install dependencies via `pip install -r requirements.txt`.
- **Battery tests failing due to SoC mismatch**: remember the default battery starts at 50% SoC; pass `soc_init=0.0` when needed.
- **Matplotlib cache errors in Docker**: set `MPLCONFIGDIR=/tmp/matplotlib` and `XDG_CACHE_HOME=/tmp` (already configured in `docker-compose.yml`).

---

## Next steps

- Hook `PVModelSingleDiode` into panel persistence once richer datasheets are available.
- Expand frontend flows (scenario builder, results dashboard).
- Add regression tests around Docker images/compose stack if CI supports container runs.
